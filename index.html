<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿé’¢ç´</title>
    <style>
        /* ç¡®ä¿å…¨å±€ä½¿ç”¨ border-box ç›’æ¨¡å‹ï¼Œæ–¹ä¾¿è®¡ç®—å…ƒç´ å°ºå¯¸ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            /* ç¡®ä¿ html å’Œ body å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
            margin: 0;
            padding: 0;
            /* ç¡®ä¿æ²¡æœ‰é»˜è®¤è¾¹è· */
        }

        body {
            display: flex; /* ä½¿ç”¨ flex å¸ƒå±€ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            background-color: #f0f0f0;
            font-family: sans-serif;
            overflow: hidden; /* éšè—æ»šåŠ¨æ¡ */
        }

        /* å†…éƒ¨æ»šåŠ¨å®¹å™¨ï¼Œè´Ÿè´£æ°´å¹³æ»šåŠ¨ */
        .scroll-container {
            width: 100vw;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
        }

        /* é’¢ç´ä¸»ä½“å®¹å™¨ */
        #piano {
            position: relative;
            /* å…³é”®ï¼šå­å…ƒç´ ç»å¯¹å®šä½çš„å‚ç…§ */
            background-color: #333;
            padding: 20px;
            /* å®¹å™¨å†…éƒ¨çš„å†…è¾¹è· */
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            /* å®¹å™¨çš„å®½åº¦å’Œé«˜åº¦å°†ç”± JavaScript åŠ¨æ€è®¾ç½®ï¼Œä»¥é€‚åº”æŒ‰é”®æ•°é‡ */
            height: 240px;
            /* é”®é«˜ 200px + ä¸Šä¸‹å†…è¾¹è· 20px*2 = 240px */
        }

        /* æ‰€æœ‰ç´é”®çš„é€šç”¨æ ·å¼ */
        .key {
            position: absolute;
            /* å…³é”®ï¼šæ‰€æœ‰é”®éƒ½ä½¿ç”¨ç»å¯¹å®šä½ */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            /* é”®åå’Œå¿«æ·é”®å‚ç›´æ’åˆ— */
            justify-content: flex-end;
            /* å†…å®¹é é”®çš„åº•éƒ¨å¯¹é½ */
            align-items: center;
            /* å†…å®¹æ°´å¹³å±…ä¸­ */
            padding-bottom: 10px;
            /* é”®åº•éƒ¨å†…è¾¹è·ï¼Œè®©æ–‡å­—ä¸ç´§è´´è¾¹ç¼˜ */
            font-size: 0.9em;
            font-weight: bold; /* æ–°å¢ï¼šåŠ ç²—å­—ä½“ */
            user-select: none;
            /* é˜²æ­¢æ–‡æœ¬è¢«é€‰ä¸­ */
            text-align: center;
            line-height: 1.2;
            white-space: normal;
            /* å…è®¸æ–‡æœ¬æ¢è¡Œ */
            /* åŠ¨ç”»æ•ˆæœï¼Œä½¿ç‚¹å‡»/æŒ‰ä¸‹æ—¶æœ‰å¹³æ»‘åé¦ˆ */
            transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background-color 2.5s ease-out; /* æ–°å¢ background-color è¿‡æ¸¡ï¼Œæ—¶é•¿ 2.5 ç§’ */
        }

        /* ç™½é”®æ ·å¼ */
        .key.white {
            height: 200px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            z-index: 0;
            top: 20px;
        }

        /* é»‘é”®æ ·å¼ */
        .key.black {
            height: 120px;
            background-color: black;
            border: 1px solid #555;
            border-radius: 0 0 5px 5px;
            z-index: 1;
            color: #eee;
            top: 20px;
        }

        /* é”®ç›˜æ˜ å°„æ–‡å­—æ ·å¼ */
        .key .keyboard-mapping {
            color: #fc54da;
            font-weight: bold;
        }

        .key.black .keyboard-mapping {
            color: #87CEEB;
        }

        /* é”®è¢«æŒ‰ä¸‹æˆ–æ¿€æ´»æ—¶çš„æ ·å¼ */
        .key.active {
            transform: translateY(2px);
            /* å‘ä¸‹ç§»åŠ¨ 2px */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            /* å†…éƒ¨é˜´å½± */
            transition: background-color 0.1s ease-out;
            /* æ¿€æ´»æ—¶å¿«é€Ÿè¿‡æ¸¡èƒŒæ™¯è‰² */
        }

        /* é»‘é”®æ¿€æ´»æ—¶çš„ç‰¹æ®Šé˜´å½±æ•ˆæœ */
        .key.black.active {
            box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.2);
        }

        /* æ–°å¢ï¼šåº•éƒ¨è®¾ç½®æ æ ·å¼ */
        .bottom-settings-bar {
            position: fixed; /* å›ºå®šå®šä½ */
            bottom: 0; /* åº•éƒ¨å¯¹é½ */
            left: 0; /* å·¦ä¾§å¯¹é½ */
            width: 100%; /* å®½åº¦å æ»¡ */
            background-color: rgba(0, 0, 0, 0.8); /* åŠé€æ˜èƒŒæ™¯ */
            padding: 10px 10px;
            display: flex; /* ä½¿ç”¨ flex å¸ƒå±€ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 15px; /* å…ƒç´ ä¹‹é—´çš„é—´è· */
            z-index: 2000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3); /* é¡¶éƒ¨é˜´å½± */
            color: white;
            font-size: 1em;
            flex-wrap: nowrap; /* ä¸å…è®¸é¡¹ç›®æ¢è¡Œ */
            user-select: none;
        }



        /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .custom-select {
            position: relative;
            display: inline-block;
        }

        .custom-select-trigger {
            padding: 8px 35px 8px 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            font-size: 1em;
            cursor: pointer;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9c-3.6%2C3.6-7.8%2C5.3-12.8%2C5.3s-9.2-1.8-12.8-5.3L146.2%2C88.8L30.9%2C197.9c-3.6%2C3.6-7.8%2C5.3-12.8%2C5.3s-9.2-1.8-12.8-5.3c-7-7-7-18.4%2C0-25.4l128-128c3.6-3.6%2C7.8-5.3%2C12.8-5.3s9.2%2C1.8%2C12.8%2C5.3l128%2C128C294%2C179.5%2C294%2C190.9%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
            min-width: 120px;
            text-align: center;
        }

        .custom-select-trigger:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .custom-select-options {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: #333;
            border: 1px solid #555;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .custom-select-options.show {
            display: block;
        }

        .custom-select-option {
            padding: 8px 10px;
            cursor: pointer;
            text-align: center;
            color: white;
            transition: background-color 0.2s;
        }

        .custom-select-option:hover {
            background-color: #4CAF50;
        }

        .custom-select-option.selected {
            background-color: #4CAF50;
        }

        /* æ§åˆ¶å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .control-icon {
            background: none;
            border: none;
            color: purple;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
            position: relative;
        }

        /* æ»‘åŠ¨æ¡æ§åˆ¶å®¹å™¨ */
        .scroll-sensitivity-control,
        .volume-control,
        .keyboard-size-control {
            position: relative;
        }

        .control-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .control-icon.active {
            background-color: #4CAF50;
        }

        /* å‚ç›´æ»‘åŠ¨æ¡å¼¹å‡ºé¢æ¿æ ·å¼ */
        .vertical-slider-panel {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 15px 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-height: 150px;
            z-index: 3000;
            margin-bottom: 5px;
        }

        .vertical-slider-panel.show {
            display: flex;
        }

        .vertical-slider-panel label {
            color: white;
            font-size: 1em;
            margin-bottom: 5px;
            text-align: center;
        }

        /* å‚ç›´æ»‘åŠ¨æ¡æ ·å¼ */
        .vertical-slider {
            -webkit-appearance: slider-vertical;
            width: 6px;
            height: 100px;
            background: #555;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
        }

        .vertical-slider:hover {
            opacity: 1;
        }

        .vertical-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .vertical-slider::-webkit-slider-runnable-track {
            background: #555;
            border-radius: 3px;
        }

        .vertical-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .vertical-slider::-moz-range-track {
            background: #555;
            border-radius: 3px;
        }

        /* é”®ç›˜æ˜ å°„æ˜¾ç¤ºå¼€å…³æ ·å¼ */
        .keyboard-mapping-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyboard-mapping-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4CAF50;
        }

        .keyboard-mapping-toggle label {
            cursor: pointer;
            font-size: 1em;
            color: yellow;
        }

        /* ä¸‹æ‹‰æ¡†å®¹å™¨æ ·å¼ */
        .note-display-options,
        .key-effect-options {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-display-options label,
        .key-effect-options label {
            color: yellow;
        }

        /* æ–°å¢ï¼šé£è¡ŒåŠ¨ç”»éŸ³ç¬¦æ ·å¼ */
        .flying-note {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            color: white; /* åˆå§‹é¢œè‰²ä¸ºç™½è‰²ï¼Œä¼šè¢« JS è¦†ç›– */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            pointer-events: none; /* ç¡®ä¿ä¸å½±å“é¼ æ ‡äº‹ä»¶ */
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
            z-index: 100; /* ç¡®ä¿éŸ³ç¬¦åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            white-space: nowrap; /* é˜²æ­¢éŸ³ç¬¦æ–‡æœ¬æ¢è¡Œ */
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes fly-up {
            0% {
                opacity: 1;
                transform: translateY(0);
                font-size: 3em; /* åˆå§‹å­—ä½“å¤§å°ï¼Œå†æ¬¡å¢å¤§ */
            }
            100% {
                opacity: 0;
                transform: translateY(-1200px); /* å‘ä¸Šç§»åŠ¨ 1200pxï¼Œç¡®ä¿ç©¿è¿‡å±å¹• */
                font-size: 4.5em; /* ç»“æŸå­—ä½“å¤§å°ï¼Œå†æ¬¡å¢å¤§ */
            }
        }
    </style>
</head>

<body>
    <div class="scroll-container">
        <div id="piano">
            <!-- ç´é”®å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ–°å¢ï¼šåº•éƒ¨è®¾ç½®æ  -->
    <div class="bottom-settings-bar">
        <!-- æ»šåŠ¨çµæ•åº¦æ§åˆ¶å™¨ -->
        <div class="scroll-sensitivity-control">
            <button class="control-icon" id="scrollIcon" title="æ»šåŠ¨çµæ•åº¦ï¼ˆçµæ•åº¦è°ƒèŠ‚å»ºè®®ä½¿ç”¨é¼ æ ‡æ»šè½®ï¼‰" >ğŸ–±ï¸</button>
            <div class="vertical-slider-panel" id="scrollPanel">
                <label>çµæ•åº¦</label>
                <input type="range" id="scrollSensitivity" class="vertical-slider" min="0.1" max="3" value="1" step="0.1" orient="vertical">
            </div>
        </div>

        <!-- æ–°å¢ï¼šéŸ³é‡æ§åˆ¶å™¨ -->
        <div class="volume-control">
            <button class="control-icon" id="volumeIcon" title="éŸ³é‡">ğŸ”Š</button>
            <div class="vertical-slider-panel" id="volumePanel">
                <label>éŸ³é‡</label>
                <input type="range" id="volumeControl" class="vertical-slider" min="0" max="1" value="1" step="0.05" orient="vertical">
            </div>
        </div>

        <!-- æ–°å¢ï¼šé”®ç›˜å°ºå¯¸æ§åˆ¶å™¨ -->
        <div class="keyboard-size-control">
            <button class="control-icon" id="sizeIcon" title="é”®ç›˜å°ºå¯¸ (å½“å‰: 1.2ï¼Œè°ƒèŠ‚ä¸º1æ—¶å…¨å±å¯æ˜¾ç¤ºæ‰€æœ‰ç´é”®)">ğŸ“</button>
            <div class="vertical-slider-panel" id="sizePanel">
                <label>å°ºå¯¸</label>
                <input type="range" id="keyboardSizeControl" class="vertical-slider" min="0.5" max="2.0" value="1.2" step="0.1" orient="vertical">
            </div>
        </div>

        <!-- é”®ç›˜æ˜ å°„æ˜¾ç¤ºå¼€å…³ -->
        <div class="keyboard-mapping-toggle">
            <label for="showKeyboardMapping">æ˜¾ç¤ºé”®ç›˜æ˜ å°„</label>
            <input type="checkbox" id="showKeyboardMapping" checked>
        </div>

        <!-- éŸ³é«˜æ˜¾ç¤ºé€‰é¡¹ -->
        <div class="note-display-options">
            <label>éŸ³é«˜æ˜¾ç¤º</label>
            <div class="custom-select" id="noteDisplaySelect">
                <div class="custom-select-trigger">å®Œæ•´éŸ³é«˜</div>
                <div class="custom-select-options">
                    <div class="custom-select-option selected" data-value="full">å®Œæ•´éŸ³é«˜</div>
                    <div class="custom-select-option" data-value="nameOnly">åªæ˜¾ç¤ºéŸ³å</div>
                    <div class="custom-select-option" data-value="none">ä¸æ˜¾ç¤º</div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šç´é”®æ•ˆæœé€‰é¡¹ -->
        <div class="key-effect-options">
            <label>ç´é”®æ•ˆæœ</label>
            <div class="custom-select" id="keyEffectSelect">
                <div class="custom-select-trigger">é¢œè‰²+åŠ¨ç”»</div>
                <div class="custom-select-options">
                    <div class="custom-select-option selected" data-value="colorAndAnimation">é¢œè‰²+åŠ¨ç”»</div>
                    <div class="custom-select-option" data-value="colorOnly">åªæœ‰é¢œè‰²</div>
                    <div class="custom-select-option" data-value="none">é»˜è®¤æ•ˆæœ</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const piano = document.getElementById('piano');
        const pressedKeys = new Set(); // è¿½è¸ªå½“å‰æŒ‰ä¸‹çš„ç‰©ç†é”®ç›˜é”®
        let keyboardToNoteMap = {}; // åŠ¨æ€ç”Ÿæˆçš„é”®ç›˜å¿«æ·é”®åˆ°éŸ³ç¬¦çš„æ˜ å°„
        let activeMouseKey = null; // æ–°å¢ï¼šè¿½è¸ªå½“å‰é¼ æ ‡æŒ‰ä¸‹çš„é’¢ç´é”®
        const scrollContainer = document.querySelector('.scroll-container'); // è·å–æ»šåŠ¨å®¹å™¨çš„å¼•ç”¨
        console.log('scrollContainer', scrollContainer); // Debugging: Check if element is found

        // æ–°å¢ï¼šæ»šåŠ¨çµæ•åº¦ç›¸å…³å˜é‡
        const scrollSensitivityInput = document.getElementById('scrollSensitivity');
        const scrollIcon = document.getElementById('scrollIcon');
        const scrollPanel = document.getElementById('scrollPanel');
        let scrollSensitivity = parseFloat(localStorage.getItem('scrollSensitivity')) || 1.0; // ä» localStorage è·å–æˆ–ä½¿ç”¨é»˜è®¤å€¼
        scrollSensitivityInput.value = scrollSensitivity; // è®¾ç½®æ»‘åŠ¨æ¡çš„åˆå§‹å€¼

        // æ–°å¢ï¼šéŸ³é‡æ§åˆ¶ç›¸å…³å˜é‡
        const volumeControlInput = document.getElementById('volumeControl');
        const volumeIcon = document.getElementById('volumeIcon');
        const volumePanel = document.getElementById('volumePanel');
        let currentVolume = parseFloat(localStorage.getItem('currentVolume')) || 1.0; // é»˜è®¤éŸ³é‡ä¸º 1.0 (æœ€å¤§)
        volumeControlInput.value = currentVolume; // è®¾ç½®æ»‘åŠ¨æ¡çš„åˆå§‹å€¼
        let volumeDebounceTimer = null; // éŸ³é‡è°ƒèŠ‚é˜²æŠ–å®šæ—¶å™¨

        // é”®ç›˜å°ºå¯¸æ¯”ä¾‹å˜é‡ï¼ˆå¿…é¡»åœ¨ä½¿ç”¨å‰å£°æ˜ï¼‰
        let keyboardSizeRatio = parseFloat(localStorage.getItem('keyboardSizeRatio')) || 1.2;
        
        // æ–°å¢ï¼šé”®ç›˜å°ºå¯¸æ§åˆ¶ç›¸å…³å˜é‡
        const keyboardSizeInput = document.getElementById('keyboardSizeControl');
        const sizeIcon = document.getElementById('sizeIcon');
        const sizePanel = document.getElementById('sizePanel');
        keyboardSizeInput.value = keyboardSizeRatio;
        sizeIcon.title = `é”®ç›˜å°ºå¯¸ (å½“å‰: ${keyboardSizeRatio.toFixed(1)}ï¼Œå…¨å±æ˜¾ç¤ºæ—¶ä¸º1)`;

        // æ–°å¢ï¼šé”®ç›˜æ˜ å°„æ˜¾ç¤ºå¼€å…³ç›¸å…³å˜é‡
        const showKeyboardMappingCheckbox = document.getElementById('showKeyboardMapping');
        let showKeyboardMapping = localStorage.getItem('showKeyboardMapping') !== 'false'; // é»˜è®¤æ˜¾ç¤º
        showKeyboardMappingCheckbox.checked = showKeyboardMapping;

        // æ–°å¢ï¼šç´é”®æ•ˆæœé€‰é¡¹ç›¸å…³å˜é‡
        const keyEffectSelect = document.getElementById('keyEffectSelect');
        let currentKeyEffectMode = localStorage.getItem('keyEffectMode') || 'colorAndAnimation'; // é»˜è®¤æŒ‰é”®åŠ é¢œè‰²æ•ˆæœå¹¶æœ‰éŸ³ç¬¦åŠ¨ç”»

        // æ–°å¢ï¼šéšæœºæ¿€æ´»é¢œè‰²æ•°ç»„
        const activeColors = ['#FF6B6B', '#FFA07A', '#FFD54F', '#62D2A2', '#007bff', '#A06CD5', '#FF8AD8'];

        // æ–°å¢ï¼šè·å–éšæœºé¢œè‰²å‡½æ•°
        function getRandomActiveColor() {
            const randomIndex = Math.floor(Math.random() * activeColors.length);
            return activeColors[randomIndex];
        }



        // æ–°å¢ï¼šéŸ³é«˜æ˜¾ç¤ºé€‰é¡¹ç›¸å…³å˜é‡
        const noteDisplaySelect = document.getElementById('noteDisplaySelect');
        let currentNoteDisplayMode = localStorage.getItem('noteDisplayMode') || 'full'; // é»˜è®¤å®Œæ•´éŸ³é«˜

        // å…¨å±€å˜é‡æ¥å­˜å‚¨éŸ³ç¬¦æ–‡ä»¶ååˆ°å®Œæ•´éŸ³ç¬¦åç§°çš„æ˜ å°„
        let fileNameToNoteNameMap = new Map();

        // ç”¨æˆ·æä¾›çš„ C2-B6 éŸ³ååˆ—è¡¨
        const semiToneOrder = [
            'C2', 'C#2', 'D2', 'D#2', 'E2', 'F2', 'F#2', 'G2', 'G#2', 'A2', 'A#2', 'B2',
            'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5', 'C#5', 'D5', 'D#5', 'E5', 'F5', 'F#5', 'G5', 'G#5', 'A5', 'A#5', 'B5',
            'C6', 'C#6', 'D6', 'D#6', 'E6', 'F6', 'F#6', 'G6', 'G#6', 'A6', 'A#6', 'B6'
        ];

        // é”®çš„å°ºå¯¸ï¼ˆå¿…é¡»ä¸ CSS ä¸­çš„å€¼ä¸€è‡´ï¼‰
        const BASE_WHITE_KEY_WIDTH = 48;
        const BASE_BLACK_KEY_WIDTH = 28;
        const BASE_BLACK_KEY_OFFSET = BASE_WHITE_KEY_WIDTH - 0.5 * BASE_BLACK_KEY_WIDTH;
        const PIANO_HORIZONTAL_PADDING = 13.5;
        
        function getScaledDimensions() {
            return {
                whiteKeyWidth: BASE_WHITE_KEY_WIDTH * keyboardSizeRatio,
                blackKeyWidth: BASE_BLACK_KEY_WIDTH * keyboardSizeRatio,
                blackKeyOffset: BASE_BLACK_KEY_OFFSET * keyboardSizeRatio
            };
        }



        // ç”Ÿæˆé’¢ç´é”®çš„å‡½æ•°
        async function generatePianoKeys() {
            const noteMappingData = await window.preload.getNoteMapping();
            if (!noteMappingData || noteMappingData.length === 0) {
                console.error("æ— æ³•ä» preload.js åŠ è½½éŸ³ç¬¦æ˜ å°„æ•°æ®ã€‚");
                piano.innerHTML = "<p>æ— æ³•åŠ è½½é’¢ç´éŸ³ç¬¦æ˜ å°„ï¼Œè¯·æ£€æŸ¥ preload.jsã€‚</p>";
                return;
            }

            piano.innerHTML = ''; // æ¸…ç©ºç°æœ‰é”®

            // åˆ›å»ºä¸€ä¸ªéŸ³ç¬¦åç§°åˆ°æ•°æ®çš„æ˜ å°„ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
            const musicalNoteNameToDataMap = new Map();
            // æ–°å¢ï¼šåˆ›å»ºä¸€ä¸ªéŸ³ç¬¦æ–‡ä»¶åï¼ˆæ— æ‰©å±•åï¼‰åˆ°å®Œæ•´éŸ³ç¬¦åç§°çš„æ˜ å°„
            const fileNameToNoteNameMap = new Map();

            noteMappingData.forEach(note => {
                musicalNoteNameToDataMap.set(note.name, note);
                fileNameToNoteNameMap.set(note.url.replace('.mp3', ''), note.name);
            });

            // å­˜å‚¨ç™½é”®çš„å¸ƒå±€ä¿¡æ¯ï¼Œç”¨äºåç»­å®šä½é»‘é”®
            const whiteKeyLayoutInfo = new Map(); // æ˜ å°„ï¼šéŸ³ç¬¦åç§° -> { leftPos: number } (ç™½é”®å·¦ä¾§ç»å¯¹ä½ç½®)

            let currentWhiteKeyLeftOffset = 0; // ç”¨äºè®¡ç®—ä¸‹ä¸€ä¸ªç™½é”®çš„å·¦ä¾§ä½ç½®

            // ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¹¶å®šä½æ‰€æœ‰ç™½é”®
            for (const musicalNoteName of semiToneOrder) {
                const noteData = musicalNoteNameToDataMap.get(musicalNoteName);
                // å¦‚æœéŸ³ç¬¦æ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™è·³è¿‡
                if (!noteData) continue;

                if (noteData.type === 'white') {
                    const dimensions = getScaledDimensions();
                    const keyDiv = document.createElement('div');
                    keyDiv.classList.add('key', 'white');
                    keyDiv.dataset.note = noteData.url.replace('.mp3', '');
                    keyDiv.dataset.key = noteData.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');

                    keyDiv.style.width = `${dimensions.whiteKeyWidth}px`;

                    let noteText = '';
                    if (currentNoteDisplayMode === 'full') {
                        noteText = `${noteData.name}`;
                    } else if (currentNoteDisplayMode === 'nameOnly') {
                        noteText = `${noteData.name.replace(/[0-9]/g, '')}`;
                    } else if (currentNoteDisplayMode === 'none') {
                        noteText = '';
                    }

                    if (noteData.name === 'C4' && currentNoteDisplayMode !== 'none') {
                        noteText = 'ä¸­å¤®C<br/>' + noteText;
                    }

                    noteText += '<br/>';
                    if (showKeyboardMapping && noteData.key) {
                        noteText += `<span class="keyboard-mapping">${noteData.key}</span>`;
                    }

                    keyDiv.innerHTML = noteText;
                    keyDiv.style.left = `${currentWhiteKeyLeftOffset + PIANO_HORIZONTAL_PADDING}px`;
                    piano.appendChild(keyDiv);

                    whiteKeyLayoutInfo.set(noteData.name, {
                        leftPos: currentWhiteKeyLeftOffset + PIANO_HORIZONTAL_PADDING
                    });

                    currentWhiteKeyLeftOffset += dimensions.whiteKeyWidth;
                }
            }

            // æ ¹æ®ç™½é”®çš„æ€»å®½åº¦è°ƒæ•´é’¢ç´å®¹å™¨çš„å®½åº¦
            // åŠ ä¸Šå·¦å³å†…è¾¹è·
            piano.style.width = `${currentWhiteKeyLeftOffset + (2 * PIANO_HORIZONTAL_PADDING)}px`;

            // åˆå§‹æ»šåŠ¨åˆ°ä¸­å¿ƒä½ç½®ï¼Œå¦‚æœå†…å®¹æº¢å‡º
            if (scrollContainer && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                scrollContainer.scrollLeft = (scrollContainer.scrollWidth - scrollContainer.clientWidth) / 2;
                console.log('Initial Scroll: scrollWidth=', scrollContainer.scrollWidth, 'clientWidth=', scrollContainer.clientWidth, 'scrollLeft=', scrollContainer.scrollLeft); // Debugging initial scroll
            }

            // ç¬¬äºŒæ­¥ï¼šç”Ÿæˆå¹¶å®šä½æ‰€æœ‰é»‘é”®
            for (const musicalNoteName of semiToneOrder) {
                const noteData = musicalNoteNameToDataMap.get(musicalNoteName);
                if (!noteData) continue;

                if (noteData.type === 'black') {
                    const dimensions = getScaledDimensions();
                    const keyDiv = document.createElement('div');
                    keyDiv.classList.add('key', 'black');
                    keyDiv.dataset.note = noteData.url.replace('.mp3', '');
                    keyDiv.dataset.key = noteData.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');

                    keyDiv.style.width = `${dimensions.blackKeyWidth}px`;

                    let noteText = '';
                    if (currentNoteDisplayMode === 'full') {
                        noteText = `${noteData.name}`;
                    } else if (currentNoteDisplayMode === 'nameOnly') {
                        noteText = `${noteData.name.replace(/[0-9]/g, '')}`;
                    } else if (currentNoteDisplayMode === 'none') {
                        noteText = '';
                    }

                    if (noteData.name === 'C4' && currentNoteDisplayMode !== 'none') {
                        noteText = 'ä¸­å¤®C<br/>' + noteText;
                    }

                    noteText += '<br/>';
                    if (showKeyboardMapping && noteData.key) {
                        noteText += `<span class="keyboard-mapping">${noteData.key}</span>`;
                    }

                    keyDiv.innerHTML = noteText;

                    const blackNoteMusicalBase = musicalNoteName.slice(0, 2);
                    const blackNoteOctave = musicalNoteName.slice(-1);

                    let precedingWhiteNoteName;

                    switch (blackNoteMusicalBase) {
                        case 'C#': precedingWhiteNoteName = 'C' + blackNoteOctave; break;
                        case 'D#': precedingWhiteNoteName = 'D' + blackNoteOctave; break;
                        case 'F#': precedingWhiteNoteName = 'F' + blackNoteOctave; break;
                        case 'G#': precedingWhiteNoteName = 'G' + blackNoteOctave; break;
                        case 'A#': precedingWhiteNoteName = 'A' + blackNoteOctave; break;
                        default:
                            console.warn(`é»‘é”®éŸ³ç¬¦ ${musicalNoteName} çš„åŸºç¡€éŸ³åä¸ç¬¦åˆé¢„æœŸï¼Œè·³è¿‡ã€‚`);
                            continue;
                    }

                    const associatedWhiteKeyInfo = whiteKeyLayoutInfo.get(precedingWhiteNoteName);

                    if (associatedWhiteKeyInfo) {
                        const whiteKeyLeft = associatedWhiteKeyInfo.leftPos;
                        const blackKeyComputedLeft = whiteKeyLeft + dimensions.blackKeyOffset;
                        
                        keyDiv.style.left = `${blackKeyComputedLeft}px`;
                        piano.appendChild(keyDiv);
                    } else {
                        console.warn(`æ‰¾ä¸åˆ°é»‘é”® ${musicalNoteName} çš„å…³è”ç™½é”®ï¼Œè·³è¿‡ã€‚`);
                    }
                }
            }

            assignKeyboardShortcuts(noteMappingData);
        }

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ç›‘å¬å™¨
        piano.addEventListener('mousedown', (e) => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¦é”®ç‚¹å‡» (e.button === 0)
            if (e.button === 0) {
                const key = e.target.closest('.key');
                if (key) {
                    const applyColor = currentKeyEffectMode === 'colorAndAnimation' || currentKeyEffectMode === 'colorOnly';
                    const applyAnimation = currentKeyEffectMode === 'colorAndAnimation';

                    if (activeMouseKey && activeMouseKey !== key) {
                        activeMouseKey.classList.remove('active');
                        activeMouseKey.style.backgroundColor = ''; // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²
                    }
                    
                    if (applyColor) {
                        key.classList.add('active');
                        const activeColor = getRandomActiveColor(); // è·å–éšæœºæ¿€æ´»é¢œè‰²
                        key.style.backgroundColor = activeColor; // è®¾ç½®æ¿€æ´»é¢œè‰²
                    } else {
                        key.classList.add('active'); // å³ä½¿æ²¡æœ‰é¢œè‰²æ•ˆæœï¼Œä¹Ÿæ·»åŠ  active ç±»æ¥åº”ç”¨ transform å’Œ box-shadow
                    }

                    window.preload.playNote(key.dataset.note, currentVolume);
                    activeMouseKey = key; // è®°å½•å½“å‰è¢«é¼ æ ‡æŒ‰ä¸‹çš„é”®

                    // æ–°å¢ï¼šå¦‚æœå¼€å¯äº†åŠ¨ç”»æ•ˆæœï¼Œåˆ™åˆ›å»ºé£è¡ŒåŠ¨ç”»éŸ³ç¬¦
                    if (applyAnimation) {
                        createFlyingNote(key, key.style.backgroundColor); // ä¼ é€’å½“å‰è®¾ç½®çš„èƒŒæ™¯é¢œè‰²
                    }
                }
            }
        });

        // é¼ æ ‡æ¾å¼€äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('mouseup', () => { // åœ¨æ•´ä¸ªæ–‡æ¡£ä¸Šç›‘å¬ï¼Œä»¥ç¡®ä¿æ— è®ºé¼ æ ‡åœ¨å“ªé‡Œæ¾å¼€éƒ½èƒ½æ•è·
            if (activeMouseKey) {
                activeMouseKey.classList.remove('active');
                activeMouseKey.style.backgroundColor = ''; // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²ï¼Œè§¦å‘æ¸å˜
                activeMouseKey = null; // æ¸…é™¤è®°å½•
            }
        });

        // ç‰©ç†é”®ç›˜æŒ‰ä¸‹äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', (e) => {
            if (!e.repeat) { // ä»…åœ¨é¦–æ¬¡æŒ‰ä¸‹æ—¶è§¦å‘ï¼Œé˜²æ­¢é•¿æŒ‰é‡å¤æ’­æ”¾
                let keyChar;

                // å¤„ç† Shift ç»„åˆé”®
                if (e.shiftKey && e.key !== 'Shift') {
                    // å¯¹äºæ•°å­—é”®ï¼Œä½¿ç”¨ e.code æ¥è·å–ç‰©ç†é”®ä½
                    if (e.code.startsWith('Digit')) {
                        const digit = e.code.replace('Digit', '');
                        keyChar = 'â‡§+' + digit;
                    } else {
                        keyChar = 'â‡§+' + e.key.toLowerCase();
                    }
                } else if (e.key === 'Shift') {
                    return; // Shift é”®æœ¬èº«ä¸ä½œä¸ºéŸ³ç¬¦å¤„ç†
                } else {
                    keyChar = e.key.toLowerCase();
                }

                const targetNoteFileName = keyboardToNoteMap[keyChar];

                if (targetNoteFileName && !pressedKeys.has(keyChar)) {
                    const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                    if (pianoKey) {
                        const applyColor = currentKeyEffectMode === 'colorAndAnimation' || currentKeyEffectMode === 'colorOnly';
                        const applyAnimation = currentKeyEffectMode === 'colorAndAnimation';

                        if (applyColor) {
                            pianoKey.classList.add('active');
                            const activeColor = getRandomActiveColor();
                            pianoKey.style.backgroundColor = activeColor;
                        } else {
                            pianoKey.classList.add('active');
                        }

                        window.preload.playNote(targetNoteFileName, currentVolume);
                        pressedKeys.add(keyChar);
                        e.preventDefault();
                        
                        if (applyAnimation) {
                            createFlyingNote(pianoKey, pianoKey.style.backgroundColor);
                        }
                    }
                }
            }
        });

        // ç‰©ç†é”®ç›˜æ¾å¼€äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keyup', (e) => {
            // å¤„ç† Shift é”®æ¾å¼€æ—¶ï¼Œæ¸…ç†æ‰€æœ‰ Shift ç»„åˆé”®
            if (e.key === 'Shift') {
                // éå†æ‰€æœ‰å½“å‰æŒ‰ä¸‹çš„é”®ï¼Œæ‰¾åˆ° Shift ç»„åˆé”®å¹¶æ¸…ç†
                const shiftKeys = Array.from(pressedKeys).filter(key => key.startsWith('â‡§+'));
                shiftKeys.forEach(shiftKey => {
                    const targetNoteFileName = keyboardToNoteMap[shiftKey];
                    if (targetNoteFileName) {
                        const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                        if (pianoKey) {
                            pianoKey.classList.remove('active');
                            pianoKey.style.backgroundColor = '';
                            pressedKeys.delete(shiftKey);
                        }
                    }
                });
                return;
            }

            let keyChar = e.key.toLowerCase();

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„ Shift ç»„åˆé”®éœ€è¦æ¸…ç†
            let shiftKeyChar;
            if (e.code && e.code.startsWith('Digit')) {
                const digit = e.code.replace('Digit', '');
                shiftKeyChar = 'â‡§+' + digit;
            } else {
                shiftKeyChar = 'â‡§+' + e.key.toLowerCase();
            }
            
            if (pressedKeys.has(shiftKeyChar)) {
                keyChar = shiftKeyChar;
            }

            const targetNoteFileName = keyboardToNoteMap[keyChar];

            if (targetNoteFileName) {
                const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                if (pianoKey) {
                    pianoKey.classList.remove('active');
                    pianoKey.style.backgroundColor = ''; // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²ï¼Œè§¦å‘æ¸å˜
                    pressedKeys.delete(keyChar);
                }
            }
        });

        // åˆ†é…é”®ç›˜å¿«æ·é”®åˆ°å¯è§çš„é’¢ç´éŸ³ç¬¦
        const assignKeyboardShortcuts = (mapping) => {
            keyboardToNoteMap = {}; // æ¸…ç©ºä¹‹å‰çš„æ˜ å°„

            mapping.forEach(note => {
                // ä½¿ç”¨æ˜ å°„æ•°æ®ä¸­çš„ `key` å±æ€§ä½œä¸ºé”®ç›˜å¿«æ·é”®
                const cleanedKey = note.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');
                keyboardToNoteMap[cleanedKey] = note.url.replace('.mp3', '');
            });
            console.log("é”®ç›˜éŸ³ç¬¦æ˜ å°„è¡¨:", keyboardToNoteMap);
        };

        generatePianoKeys(); // åˆå§‹è°ƒç”¨ä»¥ç”Ÿæˆé’¢ç´é”®

        // æ–°å¢ï¼šåˆ›å»ºé£è¡ŒåŠ¨ç”»éŸ³ç¬¦çš„å‡½æ•°
        function createFlyingNote(keyElement, color) {
            const flyingNote = document.createElement('div');
            flyingNote.classList.add('flying-note');
            
            // è·å–é”®çš„éŸ³ç¬¦æ•°æ®ï¼ˆä¾‹å¦‚ 'C4' æˆ– 'C'ï¼‰
            const noteFileName = keyElement.dataset.note;
            const fullNoteName = fileNameToNoteNameMap.get(noteFileName) || noteFileName; // å°è¯•è·å–å®Œæ•´éŸ³ç¬¦åï¼Œå¦åˆ™ä½¿ç”¨æ–‡ä»¶å

            let displayText = '';
            if (currentNoteDisplayMode === 'full') {
                displayText = fullNoteName;
            } else if (currentNoteDisplayMode === 'nameOnly') {
                displayText = fullNoteName.replace(/[0-9]/g, '');
            } else if (currentNoteDisplayMode === 'none') {
                displayText = ''; // ä¸æ˜¾ç¤ºæ—¶ä¸ºç©º
            }

            flyingNote.textContent = 'â™ª'; // ç›´æ¥è®¾ç½®ä¸ºéŸ³ç¬¦ç¬¦å·
            flyingNote.style.color = color; // è®¾ç½®éŸ³ç¬¦é¢œè‰²ä¸é”®çš„æ¿€æ´»é¢œè‰²ä¸€è‡´

            // è·å–é”®çš„ä½ç½®å’Œå°ºå¯¸ï¼Œç”¨äºå®šä½éŸ³ç¬¦
            const keyRect = keyElement.getBoundingClientRect();
            // const pianoRect = piano.getBoundingClientRect(); // ä¸å†éœ€è¦é’¢ç´çš„ Rect
            // const scrollContainerRect = scrollContainer.getBoundingClientRect(); // ä¸å†éœ€è¦æ»šåŠ¨å®¹å™¨çš„ Rect

            // è°ƒè¯•ï¼šæ‰“å°é”®å’Œç›¸å…³å®¹å™¨çš„ä½ç½®ä¿¡æ¯
            console.log('keyRect:', keyRect);
            console.log('scrollContainer.scrollLeft:', scrollContainer.scrollLeft);

            // è®¡ç®—ç›¸å¯¹äºè§†å£çš„åç§»é‡
            // flyingNote çš„ left åº”è¯¥åŸºäº key çš„ä¸­å¿ƒç‚¹ï¼Œç›¸å¯¹äºè§†å£å·¦è¾¹ç¼˜
            // è°ƒæ•´ leftOffset ä»¥è€ƒè™‘ scrollContainer çš„æ»šåŠ¨ä½ç½®
            const leftOffset = keyRect.left + keyRect.width / 2; // å·²ç»æ˜¯ç›¸å¯¹äºè§†å£çš„äº†
            const topOffset = keyRect.top;

            flyingNote.style.left = `${leftOffset}px`;
            flyingNote.style.top = `${topOffset}px`;
            flyingNote.style.transform = `translateX(-50%)`; // å°†éŸ³ç¬¦æ°´å¹³å±…ä¸­

            document.body.appendChild(flyingNote); // ç›´æ¥æ·»åŠ åˆ° body

            // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ï¼Œç¡®ä¿åŠ¨ç”»ä»åˆå§‹çŠ¶æ€å¼€å§‹
            void flyingNote.offsetWidth; 

            // æ·»åŠ åŠ¨ç”»ç±»
            flyingNote.style.animation = 'fly-up 4s ease-out forwards'; // åº”ç”¨åŠ¨ç”»ï¼Œæ—¶é•¿è°ƒæ•´ä¸º 2 ç§’

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            flyingNote.addEventListener('animationend', () => {
                flyingNote.remove();
            });
        }

        // ç›‘å¬é¼ æ ‡æ»šè½®äº‹ä»¶ï¼Œå®ç°æ°´å¹³æ»šåŠ¨
        window.addEventListener('wheel', (e) => {
            if (scrollContainer && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                e.preventDefault();
                scrollContainer.scrollBy({
                    left: e.deltaY * scrollSensitivity,
                    behavior: 'smooth'
                });
            }
        }, { passive: false });

        // æ–°å¢ï¼šæ»šåŠ¨çµæ•åº¦å›¾æ ‡ç‚¹å‡»äº‹ä»¶
        scrollIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = scrollPanel.classList.contains('show');
            // éšè—å…¶ä»–é¢æ¿
            volumePanel.classList.remove('show');
            sizePanel.classList.remove('show');
            volumeIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
            // åˆ‡æ¢å½“å‰é¢æ¿
            if (isVisible) {
                scrollPanel.classList.remove('show');
                scrollIcon.classList.remove('active');
            } else {
                scrollPanel.classList.add('show');
                scrollIcon.classList.add('active');
            }
        });

        // æ–°å¢ï¼šéŸ³é‡å›¾æ ‡ç‚¹å‡»äº‹ä»¶
        volumeIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = volumePanel.classList.contains('show');
            // éšè—å…¶ä»–é¢æ¿
            scrollPanel.classList.remove('show');
            sizePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
            // åˆ‡æ¢å½“å‰é¢æ¿
            if (isVisible) {
                volumePanel.classList.remove('show');
                volumeIcon.classList.remove('active');
            } else {
                volumePanel.classList.add('show');
                volumeIcon.classList.add('active');
            }
        });

        // æ–°å¢ï¼šé”®ç›˜å°ºå¯¸å›¾æ ‡ç‚¹å‡»äº‹ä»¶
        sizeIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = sizePanel.classList.contains('show');
            // éšè—å…¶ä»–é¢æ¿
            scrollPanel.classList.remove('show');
            volumePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            volumeIcon.classList.remove('active');
            // åˆ‡æ¢å½“å‰é¢æ¿
            if (isVisible) {
                sizePanel.classList.remove('show');
                sizeIcon.classList.remove('active');
            } else {
                sizePanel.classList.add('show');
                sizeIcon.classList.add('active');
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—é¢æ¿
        document.addEventListener('click', () => {
            scrollPanel.classList.remove('show');
            volumePanel.classList.remove('show');
            sizePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            volumeIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
        });

        // é˜»æ­¢é¢æ¿å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
        scrollPanel.addEventListener('click', (e) => e.stopPropagation());
        volumePanel.addEventListener('click', (e) => e.stopPropagation());
        sizePanel.addEventListener('click', (e) => e.stopPropagation());

        // æ»šåŠ¨çµæ•åº¦é¢æ¿æ»šè½®äº‹ä»¶
        scrollPanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newValue = Math.max(0.1, Math.min(3, scrollSensitivity + delta));
            scrollSensitivity = newValue;
            scrollSensitivityInput.value = newValue;
            localStorage.setItem('scrollSensitivity', scrollSensitivity.toString());
        }, { passive: false });

        // éŸ³é‡é¢æ¿æ»šè½®äº‹ä»¶
        volumePanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            const newValue = Math.max(0, Math.min(1, currentVolume + delta));
            currentVolume = newValue;
            volumeControlInput.value = newValue;
            localStorage.setItem('currentVolume', currentVolume.toString());
            window.preload.setGlobalVolume(currentVolume);
            
            if (volumeDebounceTimer) {
                clearTimeout(volumeDebounceTimer);
            }
            volumeDebounceTimer = setTimeout(() => {
                window.preload.playNote('C4', currentVolume);
            }, 300);
        }, { passive: false });

        // æ–°å¢ï¼šç›‘å¬æ»šåŠ¨çµæ•åº¦æ»‘åŠ¨æ¡çš„å˜åŒ–
        scrollSensitivityInput.addEventListener('input', (e) => {
            scrollSensitivity = parseFloat(e.target.value);
            localStorage.setItem('scrollSensitivity', scrollSensitivity.toString()); // ä¿å­˜åˆ° localStorage
        });

        // æ–°å¢ï¼šç›‘å¬éŸ³é‡æ§åˆ¶æ»‘åŠ¨æ¡çš„å˜åŒ–
        volumeControlInput.addEventListener('input', (e) => {
            currentVolume = parseFloat(e.target.value);
            localStorage.setItem('currentVolume', currentVolume.toString()); // ä¿å­˜åˆ° localStorage
            window.preload.setGlobalVolume(currentVolume); // è°ƒç”¨ preload.js ä¸­çš„å…¨å±€éŸ³é‡è®¾ç½®å‡½æ•°
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (volumeDebounceTimer) {
                clearTimeout(volumeDebounceTimer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ300msåæ’­æ”¾éŸ³é‡æç¤º
            volumeDebounceTimer = setTimeout(() => {
                window.preload.playNote('C4', currentVolume);
            }, 300);
        });

        // æ–°å¢ï¼šç›‘å¬é”®ç›˜æ˜ å°„æ˜¾ç¤ºå¼€å…³çš„å˜åŒ–
        showKeyboardMappingCheckbox.addEventListener('change', (e) => {
            showKeyboardMapping = e.target.checked;
            localStorage.setItem('showKeyboardMapping', showKeyboardMapping.toString());
            generatePianoKeys(); // é‡æ–°ç”Ÿæˆé’¢ç´é”®ä»¥åº”ç”¨æ–°çš„æ˜¾ç¤ºè®¾ç½®
        });

        // æ–°å¢ï¼šç›‘å¬éŸ³é«˜æ˜¾ç¤ºä¸‹æ‹‰æ¡†çš„å˜åŒ–
        noteDisplaySelect.addEventListener('change', (e) => {
            currentNoteDisplayMode = e.target.value;
            localStorage.setItem('noteDisplayMode', currentNoteDisplayMode); // ä¿å­˜åˆ° localStorage
            generatePianoKeys(); // é‡æ–°ç”Ÿæˆé’¢ç´é”®ä»¥åº”ç”¨æ–°çš„æ˜¾ç¤ºæ¨¡å¼
        });

        // æ–°å¢ï¼šç›‘å¬ç´é”®æ•ˆæœä¸‹æ‹‰æ¡†çš„å˜åŒ–
        keyEffectSelect.addEventListener('change', (e) => {
            currentKeyEffectMode = e.target.value;
            localStorage.setItem('keyEffectMode', currentKeyEffectMode); // ä¿å­˜åˆ° localStorage
            // ä¸é‡æ–°ç”Ÿæˆç´é”®ï¼Œå› ä¸ºæ•ˆæœåªå½±å“ active çŠ¶æ€å’Œé£è¡ŒåŠ¨ç”»ï¼Œä¸å½±å“é”®çš„ç”Ÿæˆ
        });



        // æ–°å¢ï¼šç›‘å¬é”®ç›˜å°ºå¯¸æ»‘åŠ¨æ¡çš„å˜åŒ–
        keyboardSizeInput.addEventListener('input', (e) => {
            keyboardSizeRatio = parseFloat(e.target.value);
            localStorage.setItem('keyboardSizeRatio', keyboardSizeRatio.toString());
            sizeIcon.title = `é”®ç›˜å°ºå¯¸ (å½“å‰: ${keyboardSizeRatio.toFixed(1)}ï¼Œå…¨å±æ˜¾ç¤ºæ—¶ä¸º1)`;
            generatePianoKeys();
        });

        // é”®ç›˜å°ºå¯¸é¢æ¿æ»šè½®äº‹ä»¶
        sizePanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newValue = Math.max(0.5, Math.min(2.0, keyboardSizeRatio + delta));
            keyboardSizeRatio = newValue;
            keyboardSizeInput.value = newValue;
            localStorage.setItem('keyboardSizeRatio', keyboardSizeRatio.toString());
            sizeIcon.title = `é”®ç›˜å°ºå¯¸ (å½“å‰: ${keyboardSizeRatio.toFixed(1)}ï¼Œå…¨å±æ˜¾ç¤ºæ—¶ä¸º1)`;
            generatePianoKeys();
        }, { passive: false });

        // è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½
        function initCustomSelect(selectElement, currentValue, onChangeCallback) {
            const trigger = selectElement.querySelector('.custom-select-trigger');
            const options = selectElement.querySelector('.custom-select-options');
            const optionElements = selectElement.querySelectorAll('.custom-select-option');
            
            // è®¾ç½®åˆå§‹å€¼
            const initialOption = selectElement.querySelector(`[data-value="${currentValue}"]`);
            if (initialOption) {
                trigger.textContent = initialOption.textContent;
                optionElements.forEach(opt => opt.classList.remove('selected'));
                initialOption.classList.add('selected');
            }
            
            // ç‚¹å‡»è§¦å‘å™¨
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
                document.querySelectorAll('.custom-select-options.show').forEach(opt => {
                    if (opt !== options) opt.classList.remove('show');
                });
                options.classList.toggle('show');
            });
            
            // ç‚¹å‡»é€‰é¡¹
            optionElements.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    const text = option.textContent;
                    
                    trigger.textContent = text;
                    optionElements.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    options.classList.remove('show');
                    
                    onChangeCallback(value);
                });
            });
        }
        
        // åˆå§‹åŒ–éŸ³é«˜æ˜¾ç¤ºä¸‹æ‹‰æ¡†
        initCustomSelect(noteDisplaySelect, currentNoteDisplayMode, (value) => {
            currentNoteDisplayMode = value;
            localStorage.setItem('noteDisplayMode', currentNoteDisplayMode);
            generatePianoKeys();
        });
        
        // åˆå§‹åŒ–ç´é”®æ•ˆæœä¸‹æ‹‰æ¡†
        initCustomSelect(keyEffectSelect, currentKeyEffectMode, (value) => {
            currentKeyEffectMode = value;
            localStorage.setItem('keyEffectMode', currentKeyEffectMode);
        });
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select-options.show').forEach(options => {
                options.classList.remove('show');
            });
        });

    </script>
</body>

</html>