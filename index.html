<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟钢琴</title>
    <style>
        /* 确保全局使用 border-box 盒模型，方便计算元素尺寸 */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            /* 确保 html 和 body 占满整个视口高度 */
            margin: 0;
            padding: 0;
            /* 确保没有默认边距 */
        }

        body {
            display: flex; /* 使用 flex 布局 */
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            background-color: #f0f0f0;
            font-family: sans-serif;
            overflow: hidden; /* 隐藏滚动条 */
        }

        /* 内部滚动容器，负责水平滚动 */
        .scroll-container {
            width: 100vw;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
        }

        /* 钢琴主体容器 */
        #piano {
            position: relative;
            /* 关键：子元素绝对定位的参照 */
            background-color: #333;
            padding: 20px;
            /* 容器内部的内边距 */
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            /* 容器的宽度和高度将由 JavaScript 动态设置，以适应按键数量 */
            height: 240px;
            /* 键高 200px + 上下内边距 20px*2 = 240px */
        }

        /* 所有琴键的通用样式 */
        .key {
            position: absolute;
            /* 关键：所有键都使用绝对定位 */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            /* 键名和快捷键垂直排列 */
            justify-content: flex-end;
            /* 内容靠键的底部对齐 */
            align-items: center;
            /* 内容水平居中 */
            padding-bottom: 10px;
            /* 键底部内边距，让文字不紧贴边缘 */
            font-size: 0.9em;
            font-weight: bold; /* 新增：加粗字体 */
            user-select: none;
            /* 防止文本被选中 */
            text-align: center;
            line-height: 1.2;
            white-space: normal;
            /* 允许文本换行 */
            /* 动画效果，使点击/按下时有平滑反馈 */
            transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background-color 2.5s ease-out; /* 新增 background-color 过渡，时长 2.5 秒 */
        }

        /* 白键样式 */
        .key.white {
            height: 200px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            z-index: 0;
            top: 20px;
        }

        /* 黑键样式 */
        .key.black {
            height: 120px;
            background-color: black;
            border: 1px solid #555;
            border-radius: 0 0 5px 5px;
            z-index: 1;
            color: #eee;
            top: 20px;
        }

        /* 键盘映射文字样式 */
        .key .keyboard-mapping {
            color: #fc54da;
            font-weight: bold;
        }

        .key.black .keyboard-mapping {
            color: #87CEEB;
        }

        /* 键被按下或激活时的样式 */
        .key.active {
            transform: translateY(2px);
            /* 向下移动 2px */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            /* 内部阴影 */
            transition: background-color 0.1s ease-out;
            /* 激活时快速过渡背景色 */
        }

        /* 黑键激活时的特殊阴影效果 */
        .key.black.active {
            box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.2);
        }

        /* 新增：底部设置栏样式 */
        .bottom-settings-bar {
            position: fixed; /* 固定定位 */
            bottom: 0; /* 底部对齐 */
            left: 0; /* 左侧对齐 */
            width: 100%; /* 宽度占满 */
            background-color: rgba(0, 0, 0, 0.8); /* 半透明背景 */
            padding: 10px 10px;
            display: flex; /* 使用 flex 布局 */
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            gap: 15px; /* 元素之间的间距 */
            z-index: 2000; /* 确保在最上层 */
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3); /* 顶部阴影 */
            color: white;
            font-size: 1em;
            flex-wrap: nowrap; /* 不允许项目换行 */
            user-select: none;
        }



        /* 自定义下拉框样式 */
        .custom-select {
            position: relative;
            display: inline-block;
        }

        .custom-select-trigger {
            padding: 8px 35px 8px 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            font-size: 1em;
            cursor: pointer;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9c-3.6%2C3.6-7.8%2C5.3-12.8%2C5.3s-9.2-1.8-12.8-5.3L146.2%2C88.8L30.9%2C197.9c-3.6%2C3.6-7.8%2C5.3-12.8%2C5.3s-9.2-1.8-12.8-5.3c-7-7-7-18.4%2C0-25.4l128-128c3.6-3.6%2C7.8-5.3%2C12.8-5.3s9.2%2C1.8%2C12.8%2C5.3l128%2C128C294%2C179.5%2C294%2C190.9%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
            min-width: 120px;
            text-align: center;
        }

        .custom-select-trigger:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .custom-select-options {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: #333;
            border: 1px solid #555;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .custom-select-options.show {
            display: block;
        }

        .custom-select-option {
            padding: 8px 10px;
            cursor: pointer;
            text-align: center;
            color: white;
            transition: background-color 0.2s;
        }

        .custom-select-option:hover {
            background-color: #4CAF50;
        }

        .custom-select-option.selected {
            background-color: #4CAF50;
        }

        /* 控制图标按钮样式 */
        .control-icon {
            background: none;
            border: none;
            color: purple;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
            position: relative;
        }

        /* 滑动条控制容器 */
        .scroll-sensitivity-control,
        .volume-control,
        .keyboard-size-control {
            position: relative;
        }

        .control-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .control-icon.active {
            background-color: #4CAF50;
        }

        /* 垂直滑动条弹出面板样式 */
        .vertical-slider-panel {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 15px 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-height: 150px;
            z-index: 3000;
            margin-bottom: 5px;
        }

        .vertical-slider-panel.show {
            display: flex;
        }

        .vertical-slider-panel label {
            color: white;
            font-size: 1em;
            margin-bottom: 5px;
            text-align: center;
        }

        /* 垂直滑动条样式 */
        .vertical-slider {
            -webkit-appearance: slider-vertical;
            width: 6px;
            height: 100px;
            background: #555;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
        }

        .vertical-slider:hover {
            opacity: 1;
        }

        .vertical-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .vertical-slider::-webkit-slider-runnable-track {
            background: #555;
            border-radius: 3px;
        }

        .vertical-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .vertical-slider::-moz-range-track {
            background: #555;
            border-radius: 3px;
        }

        /* 键盘映射显示开关样式 */
        .keyboard-mapping-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyboard-mapping-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4CAF50;
        }

        .keyboard-mapping-toggle label {
            cursor: pointer;
            font-size: 1em;
            color: yellow;
        }

        /* 下拉框容器样式 */
        .note-display-options,
        .key-effect-options {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-display-options label,
        .key-effect-options label {
            color: yellow;
        }

        /* 新增：飞行动画音符样式 */
        .flying-note {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            color: white; /* 初始颜色为白色，会被 JS 覆盖 */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            pointer-events: none; /* 确保不影响鼠标事件 */
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* 平滑过渡效果 */
            z-index: 100; /* 确保音符在其他元素之上 */
            white-space: nowrap; /* 防止音符文本换行 */
        }

        /* 动画关键帧 */
        @keyframes fly-up {
            0% {
                opacity: 1;
                transform: translateY(0);
                font-size: 3em; /* 初始字体大小，再次增大 */
            }
            100% {
                opacity: 0;
                transform: translateY(-1200px); /* 向上移动 1200px，确保穿过屏幕 */
                font-size: 4.5em; /* 结束字体大小，再次增大 */
            }
        }
    </style>
</head>

<body>
    <div class="scroll-container">
        <div id="piano">
            <!-- 琴键将由 JavaScript 动态生成 -->
        </div>
    </div>

    <!-- 新增：底部设置栏 -->
    <div class="bottom-settings-bar">
        <!-- 滚动灵敏度控制器 -->
        <div class="scroll-sensitivity-control">
            <button class="control-icon" id="scrollIcon" title="滚动灵敏度（灵敏度调节建议使用鼠标滚轮）" >🖱️</button>
            <div class="vertical-slider-panel" id="scrollPanel">
                <label>灵敏度</label>
                <input type="range" id="scrollSensitivity" class="vertical-slider" min="0.1" max="3" value="1" step="0.1" orient="vertical">
            </div>
        </div>

        <!-- 新增：音量控制器 -->
        <div class="volume-control">
            <button class="control-icon" id="volumeIcon" title="音量">🔊</button>
            <div class="vertical-slider-panel" id="volumePanel">
                <label>音量</label>
                <input type="range" id="volumeControl" class="vertical-slider" min="0" max="1" value="1" step="0.05" orient="vertical">
            </div>
        </div>

        <!-- 新增：键盘尺寸控制器 -->
        <div class="keyboard-size-control">
            <button class="control-icon" id="sizeIcon" title="键盘尺寸 (当前: 1.2，调节为1时全屏可显示所有琴键)">📏</button>
            <div class="vertical-slider-panel" id="sizePanel">
                <label>尺寸</label>
                <input type="range" id="keyboardSizeControl" class="vertical-slider" min="0.5" max="2.0" value="1.2" step="0.1" orient="vertical">
            </div>
        </div>

        <!-- 键盘映射显示开关 -->
        <div class="keyboard-mapping-toggle">
            <label for="showKeyboardMapping">显示键盘映射</label>
            <input type="checkbox" id="showKeyboardMapping" checked>
        </div>

        <!-- 音高显示选项 -->
        <div class="note-display-options">
            <label>音高显示</label>
            <div class="custom-select" id="noteDisplaySelect">
                <div class="custom-select-trigger">完整音高</div>
                <div class="custom-select-options">
                    <div class="custom-select-option selected" data-value="full">完整音高</div>
                    <div class="custom-select-option" data-value="nameOnly">只显示音名</div>
                    <div class="custom-select-option" data-value="none">不显示</div>
                </div>
            </div>
        </div>

        <!-- 新增：琴键效果选项 -->
        <div class="key-effect-options">
            <label>琴键效果</label>
            <div class="custom-select" id="keyEffectSelect">
                <div class="custom-select-trigger">颜色+动画</div>
                <div class="custom-select-options">
                    <div class="custom-select-option selected" data-value="colorAndAnimation">颜色+动画</div>
                    <div class="custom-select-option" data-value="colorOnly">只有颜色</div>
                    <div class="custom-select-option" data-value="none">默认效果</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const piano = document.getElementById('piano');
        const pressedKeys = new Set(); // 追踪当前按下的物理键盘键
        let keyboardToNoteMap = {}; // 动态生成的键盘快捷键到音符的映射
        let activeMouseKey = null; // 新增：追踪当前鼠标按下的钢琴键
        const scrollContainer = document.querySelector('.scroll-container'); // 获取滚动容器的引用
        console.log('scrollContainer', scrollContainer); // Debugging: Check if element is found

        // 新增：滚动灵敏度相关变量
        const scrollSensitivityInput = document.getElementById('scrollSensitivity');
        const scrollIcon = document.getElementById('scrollIcon');
        const scrollPanel = document.getElementById('scrollPanel');
        let scrollSensitivity = parseFloat(localStorage.getItem('scrollSensitivity')) || 1.0; // 从 localStorage 获取或使用默认值
        scrollSensitivityInput.value = scrollSensitivity; // 设置滑动条的初始值

        // 新增：音量控制相关变量
        const volumeControlInput = document.getElementById('volumeControl');
        const volumeIcon = document.getElementById('volumeIcon');
        const volumePanel = document.getElementById('volumePanel');
        let currentVolume = parseFloat(localStorage.getItem('currentVolume')) || 1.0; // 默认音量为 1.0 (最大)
        volumeControlInput.value = currentVolume; // 设置滑动条的初始值
        let volumeDebounceTimer = null; // 音量调节防抖定时器

        // 键盘尺寸比例变量（必须在使用前声明）
        let keyboardSizeRatio = parseFloat(localStorage.getItem('keyboardSizeRatio')) || 1.2;
        
        // 新增：键盘尺寸控制相关变量
        const keyboardSizeInput = document.getElementById('keyboardSizeControl');
        const sizeIcon = document.getElementById('sizeIcon');
        const sizePanel = document.getElementById('sizePanel');
        keyboardSizeInput.value = keyboardSizeRatio;
        sizeIcon.title = `键盘尺寸 (当前: ${keyboardSizeRatio.toFixed(1)}，全屏显示时为1)`;

        // 新增：键盘映射显示开关相关变量
        const showKeyboardMappingCheckbox = document.getElementById('showKeyboardMapping');
        let showKeyboardMapping = localStorage.getItem('showKeyboardMapping') !== 'false'; // 默认显示
        showKeyboardMappingCheckbox.checked = showKeyboardMapping;

        // 新增：琴键效果选项相关变量
        const keyEffectSelect = document.getElementById('keyEffectSelect');
        let currentKeyEffectMode = localStorage.getItem('keyEffectMode') || 'colorAndAnimation'; // 默认按键加颜色效果并有音符动画

        // 新增：随机激活颜色数组
        const activeColors = ['#FF6B6B', '#FFA07A', '#FFD54F', '#62D2A2', '#007bff', '#A06CD5', '#FF8AD8'];

        // 新增：获取随机颜色函数
        function getRandomActiveColor() {
            const randomIndex = Math.floor(Math.random() * activeColors.length);
            return activeColors[randomIndex];
        }



        // 新增：音高显示选项相关变量
        const noteDisplaySelect = document.getElementById('noteDisplaySelect');
        let currentNoteDisplayMode = localStorage.getItem('noteDisplayMode') || 'full'; // 默认完整音高

        // 全局变量来存储音符文件名到完整音符名称的映射
        let fileNameToNoteNameMap = new Map();

        // 用户提供的 C2-B6 音名列表
        const semiToneOrder = [
            'C2', 'C#2', 'D2', 'D#2', 'E2', 'F2', 'F#2', 'G2', 'G#2', 'A2', 'A#2', 'B2',
            'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5', 'C#5', 'D5', 'D#5', 'E5', 'F5', 'F#5', 'G5', 'G#5', 'A5', 'A#5', 'B5',
            'C6', 'C#6', 'D6', 'D#6', 'E6', 'F6', 'F#6', 'G6', 'G#6', 'A6', 'A#6', 'B6'
        ];

        // 键的尺寸（必须与 CSS 中的值一致）
        const BASE_WHITE_KEY_WIDTH = 48;
        const BASE_BLACK_KEY_WIDTH = 28;
        const BASE_BLACK_KEY_OFFSET = BASE_WHITE_KEY_WIDTH - 0.5 * BASE_BLACK_KEY_WIDTH;
        const PIANO_HORIZONTAL_PADDING = 13.5;
        
        function getScaledDimensions() {
            return {
                whiteKeyWidth: BASE_WHITE_KEY_WIDTH * keyboardSizeRatio,
                blackKeyWidth: BASE_BLACK_KEY_WIDTH * keyboardSizeRatio,
                blackKeyOffset: BASE_BLACK_KEY_OFFSET * keyboardSizeRatio
            };
        }



        // 生成钢琴键的函数
        async function generatePianoKeys() {
            const noteMappingData = await window.preload.getNoteMapping();
            if (!noteMappingData || noteMappingData.length === 0) {
                console.error("无法从 preload.js 加载音符映射数据。");
                piano.innerHTML = "<p>无法加载钢琴音符映射，请检查 preload.js。</p>";
                return;
            }

            piano.innerHTML = ''; // 清空现有键

            // 创建一个音符名称到数据的映射，方便查找
            const musicalNoteNameToDataMap = new Map();
            // 新增：创建一个音符文件名（无扩展名）到完整音符名称的映射
            const fileNameToNoteNameMap = new Map();

            noteMappingData.forEach(note => {
                musicalNoteNameToDataMap.set(note.name, note);
                fileNameToNoteNameMap.set(note.url.replace('.mp3', ''), note.name);
            });

            // 存储白键的布局信息，用于后续定位黑键
            const whiteKeyLayoutInfo = new Map(); // 映射：音符名称 -> { leftPos: number } (白键左侧绝对位置)

            let currentWhiteKeyLeftOffset = 0; // 用于计算下一个白键的左侧位置

            // 第一步：生成并定位所有白键
            for (const musicalNoteName of semiToneOrder) {
                const noteData = musicalNoteNameToDataMap.get(musicalNoteName);
                // 如果音符数据不存在，则跳过
                if (!noteData) continue;

                if (noteData.type === 'white') {
                    const dimensions = getScaledDimensions();
                    const keyDiv = document.createElement('div');
                    keyDiv.classList.add('key', 'white');
                    keyDiv.dataset.note = noteData.url.replace('.mp3', '');
                    keyDiv.dataset.key = noteData.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');

                    keyDiv.style.width = `${dimensions.whiteKeyWidth}px`;

                    let noteText = '';
                    if (currentNoteDisplayMode === 'full') {
                        noteText = `${noteData.name}`;
                    } else if (currentNoteDisplayMode === 'nameOnly') {
                        noteText = `${noteData.name.replace(/[0-9]/g, '')}`;
                    } else if (currentNoteDisplayMode === 'none') {
                        noteText = '';
                    }

                    if (noteData.name === 'C4' && currentNoteDisplayMode !== 'none') {
                        noteText = '中央C<br/>' + noteText;
                    }

                    noteText += '<br/>';
                    if (showKeyboardMapping && noteData.key) {
                        noteText += `<span class="keyboard-mapping">${noteData.key}</span>`;
                    }

                    keyDiv.innerHTML = noteText;
                    keyDiv.style.left = `${currentWhiteKeyLeftOffset + PIANO_HORIZONTAL_PADDING}px`;
                    piano.appendChild(keyDiv);

                    whiteKeyLayoutInfo.set(noteData.name, {
                        leftPos: currentWhiteKeyLeftOffset + PIANO_HORIZONTAL_PADDING
                    });

                    currentWhiteKeyLeftOffset += dimensions.whiteKeyWidth;
                }
            }

            // 根据白键的总宽度调整钢琴容器的宽度
            // 加上左右内边距
            piano.style.width = `${currentWhiteKeyLeftOffset + (2 * PIANO_HORIZONTAL_PADDING)}px`;

            // 初始滚动到中心位置，如果内容溢出
            if (scrollContainer && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                scrollContainer.scrollLeft = (scrollContainer.scrollWidth - scrollContainer.clientWidth) / 2;
                console.log('Initial Scroll: scrollWidth=', scrollContainer.scrollWidth, 'clientWidth=', scrollContainer.clientWidth, 'scrollLeft=', scrollContainer.scrollLeft); // Debugging initial scroll
            }

            // 第二步：生成并定位所有黑键
            for (const musicalNoteName of semiToneOrder) {
                const noteData = musicalNoteNameToDataMap.get(musicalNoteName);
                if (!noteData) continue;

                if (noteData.type === 'black') {
                    const dimensions = getScaledDimensions();
                    const keyDiv = document.createElement('div');
                    keyDiv.classList.add('key', 'black');
                    keyDiv.dataset.note = noteData.url.replace('.mp3', '');
                    keyDiv.dataset.key = noteData.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');

                    keyDiv.style.width = `${dimensions.blackKeyWidth}px`;

                    let noteText = '';
                    if (currentNoteDisplayMode === 'full') {
                        noteText = `${noteData.name}`;
                    } else if (currentNoteDisplayMode === 'nameOnly') {
                        noteText = `${noteData.name.replace(/[0-9]/g, '')}`;
                    } else if (currentNoteDisplayMode === 'none') {
                        noteText = '';
                    }

                    if (noteData.name === 'C4' && currentNoteDisplayMode !== 'none') {
                        noteText = '中央C<br/>' + noteText;
                    }

                    noteText += '<br/>';
                    if (showKeyboardMapping && noteData.key) {
                        noteText += `<span class="keyboard-mapping">${noteData.key}</span>`;
                    }

                    keyDiv.innerHTML = noteText;

                    const blackNoteMusicalBase = musicalNoteName.slice(0, 2);
                    const blackNoteOctave = musicalNoteName.slice(-1);

                    let precedingWhiteNoteName;

                    switch (blackNoteMusicalBase) {
                        case 'C#': precedingWhiteNoteName = 'C' + blackNoteOctave; break;
                        case 'D#': precedingWhiteNoteName = 'D' + blackNoteOctave; break;
                        case 'F#': precedingWhiteNoteName = 'F' + blackNoteOctave; break;
                        case 'G#': precedingWhiteNoteName = 'G' + blackNoteOctave; break;
                        case 'A#': precedingWhiteNoteName = 'A' + blackNoteOctave; break;
                        default:
                            console.warn(`黑键音符 ${musicalNoteName} 的基础音名不符合预期，跳过。`);
                            continue;
                    }

                    const associatedWhiteKeyInfo = whiteKeyLayoutInfo.get(precedingWhiteNoteName);

                    if (associatedWhiteKeyInfo) {
                        const whiteKeyLeft = associatedWhiteKeyInfo.leftPos;
                        const blackKeyComputedLeft = whiteKeyLeft + dimensions.blackKeyOffset;
                        
                        keyDiv.style.left = `${blackKeyComputedLeft}px`;
                        piano.appendChild(keyDiv);
                    } else {
                        console.warn(`找不到黑键 ${musicalNoteName} 的关联白键，跳过。`);
                    }
                }
            }

            assignKeyboardShortcuts(noteMappingData);
        }

        // 鼠标按下事件监听器
        piano.addEventListener('mousedown', (e) => {
            // 检查是否是左键点击 (e.button === 0)
            if (e.button === 0) {
                const key = e.target.closest('.key');
                if (key) {
                    const applyColor = currentKeyEffectMode === 'colorAndAnimation' || currentKeyEffectMode === 'colorOnly';
                    const applyAnimation = currentKeyEffectMode === 'colorAndAnimation';

                    if (activeMouseKey && activeMouseKey !== key) {
                        activeMouseKey.classList.remove('active');
                        activeMouseKey.style.backgroundColor = ''; // 恢复默认背景色
                    }
                    
                    if (applyColor) {
                        key.classList.add('active');
                        const activeColor = getRandomActiveColor(); // 获取随机激活颜色
                        key.style.backgroundColor = activeColor; // 设置激活颜色
                    } else {
                        key.classList.add('active'); // 即使没有颜色效果，也添加 active 类来应用 transform 和 box-shadow
                    }

                    window.preload.playNote(key.dataset.note, currentVolume);
                    activeMouseKey = key; // 记录当前被鼠标按下的键

                    // 新增：如果开启了动画效果，则创建飞行动画音符
                    if (applyAnimation) {
                        createFlyingNote(key, key.style.backgroundColor); // 传递当前设置的背景颜色
                    }
                }
            }
        });

        // 鼠标松开事件监听器
        document.addEventListener('mouseup', () => { // 在整个文档上监听，以确保无论鼠标在哪里松开都能捕获
            if (activeMouseKey) {
                activeMouseKey.classList.remove('active');
                activeMouseKey.style.backgroundColor = ''; // 恢复默认背景色，触发渐变
                activeMouseKey = null; // 清除记录
            }
        });

        // 物理键盘按下事件监听器
        document.addEventListener('keydown', (e) => {
            if (!e.repeat) { // 仅在首次按下时触发，防止长按重复播放
                let keyChar;

                // 处理 Shift 组合键
                if (e.shiftKey && e.key !== 'Shift') {
                    // 对于数字键，使用 e.code 来获取物理键位
                    if (e.code.startsWith('Digit')) {
                        const digit = e.code.replace('Digit', '');
                        keyChar = '⇧+' + digit;
                    } else {
                        keyChar = '⇧+' + e.key.toLowerCase();
                    }
                } else if (e.key === 'Shift') {
                    return; // Shift 键本身不作为音符处理
                } else {
                    keyChar = e.key.toLowerCase();
                }

                const targetNoteFileName = keyboardToNoteMap[keyChar];

                if (targetNoteFileName && !pressedKeys.has(keyChar)) {
                    const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                    if (pianoKey) {
                        const applyColor = currentKeyEffectMode === 'colorAndAnimation' || currentKeyEffectMode === 'colorOnly';
                        const applyAnimation = currentKeyEffectMode === 'colorAndAnimation';

                        if (applyColor) {
                            pianoKey.classList.add('active');
                            const activeColor = getRandomActiveColor();
                            pianoKey.style.backgroundColor = activeColor;
                        } else {
                            pianoKey.classList.add('active');
                        }

                        window.preload.playNote(targetNoteFileName, currentVolume);
                        pressedKeys.add(keyChar);
                        e.preventDefault();
                        
                        if (applyAnimation) {
                            createFlyingNote(pianoKey, pianoKey.style.backgroundColor);
                        }
                    }
                }
            }
        });

        // 物理键盘松开事件监听器
        document.addEventListener('keyup', (e) => {
            // 处理 Shift 键松开时，清理所有 Shift 组合键
            if (e.key === 'Shift') {
                // 遍历所有当前按下的键，找到 Shift 组合键并清理
                const shiftKeys = Array.from(pressedKeys).filter(key => key.startsWith('⇧+'));
                shiftKeys.forEach(shiftKey => {
                    const targetNoteFileName = keyboardToNoteMap[shiftKey];
                    if (targetNoteFileName) {
                        const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                        if (pianoKey) {
                            pianoKey.classList.remove('active');
                            pianoKey.style.backgroundColor = '';
                            pressedKeys.delete(shiftKey);
                        }
                    }
                });
                return;
            }

            let keyChar = e.key.toLowerCase();

            // 检查是否有对应的 Shift 组合键需要清理
            let shiftKeyChar;
            if (e.code && e.code.startsWith('Digit')) {
                const digit = e.code.replace('Digit', '');
                shiftKeyChar = '⇧+' + digit;
            } else {
                shiftKeyChar = '⇧+' + e.key.toLowerCase();
            }
            
            if (pressedKeys.has(shiftKeyChar)) {
                keyChar = shiftKeyChar;
            }

            const targetNoteFileName = keyboardToNoteMap[keyChar];

            if (targetNoteFileName) {
                const pianoKey = document.querySelector(`.key[data-note="${targetNoteFileName}"]`);
                if (pianoKey) {
                    pianoKey.classList.remove('active');
                    pianoKey.style.backgroundColor = ''; // 恢复默认背景色，触发渐变
                    pressedKeys.delete(keyChar);
                }
            }
        });

        // 分配键盘快捷键到可见的钢琴音符
        const assignKeyboardShortcuts = (mapping) => {
            keyboardToNoteMap = {}; // 清空之前的映射

            mapping.forEach(note => {
                // 使用映射数据中的 `key` 属性作为键盘快捷键
                const cleanedKey = note.key.toLowerCase().replace(/<br>/g, '').replace(/\s/g, '');
                keyboardToNoteMap[cleanedKey] = note.url.replace('.mp3', '');
            });
            console.log("键盘音符映射表:", keyboardToNoteMap);
        };

        generatePianoKeys(); // 初始调用以生成钢琴键

        // 新增：创建飞行动画音符的函数
        function createFlyingNote(keyElement, color) {
            const flyingNote = document.createElement('div');
            flyingNote.classList.add('flying-note');
            
            // 获取键的音符数据（例如 'C4' 或 'C'）
            const noteFileName = keyElement.dataset.note;
            const fullNoteName = fileNameToNoteNameMap.get(noteFileName) || noteFileName; // 尝试获取完整音符名，否则使用文件名

            let displayText = '';
            if (currentNoteDisplayMode === 'full') {
                displayText = fullNoteName;
            } else if (currentNoteDisplayMode === 'nameOnly') {
                displayText = fullNoteName.replace(/[0-9]/g, '');
            } else if (currentNoteDisplayMode === 'none') {
                displayText = ''; // 不显示时为空
            }

            flyingNote.textContent = '♪'; // 直接设置为音符符号
            flyingNote.style.color = color; // 设置音符颜色与键的激活颜色一致

            // 获取键的位置和尺寸，用于定位音符
            const keyRect = keyElement.getBoundingClientRect();
            // const pianoRect = piano.getBoundingClientRect(); // 不再需要钢琴的 Rect
            // const scrollContainerRect = scrollContainer.getBoundingClientRect(); // 不再需要滚动容器的 Rect

            // 调试：打印键和相关容器的位置信息
            console.log('keyRect:', keyRect);
            console.log('scrollContainer.scrollLeft:', scrollContainer.scrollLeft);

            // 计算相对于视口的偏移量
            // flyingNote 的 left 应该基于 key 的中心点，相对于视口左边缘
            // 调整 leftOffset 以考虑 scrollContainer 的滚动位置
            const leftOffset = keyRect.left + keyRect.width / 2; // 已经是相对于视口的了
            const topOffset = keyRect.top;

            flyingNote.style.left = `${leftOffset}px`;
            flyingNote.style.top = `${topOffset}px`;
            flyingNote.style.transform = `translateX(-50%)`; // 将音符水平居中

            document.body.appendChild(flyingNote); // 直接添加到 body

            // 强制浏览器重绘，确保动画从初始状态开始
            void flyingNote.offsetWidth; 

            // 添加动画类
            flyingNote.style.animation = 'fly-up 4s ease-out forwards'; // 应用动画，时长调整为 2 秒

            // 动画结束后移除元素
            flyingNote.addEventListener('animationend', () => {
                flyingNote.remove();
            });
        }

        // 监听鼠标滚轮事件，实现水平滚动
        window.addEventListener('wheel', (e) => {
            if (scrollContainer && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                e.preventDefault();
                scrollContainer.scrollBy({
                    left: e.deltaY * scrollSensitivity,
                    behavior: 'smooth'
                });
            }
        }, { passive: false });

        // 新增：滚动灵敏度图标点击事件
        scrollIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = scrollPanel.classList.contains('show');
            // 隐藏其他面板
            volumePanel.classList.remove('show');
            sizePanel.classList.remove('show');
            volumeIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
            // 切换当前面板
            if (isVisible) {
                scrollPanel.classList.remove('show');
                scrollIcon.classList.remove('active');
            } else {
                scrollPanel.classList.add('show');
                scrollIcon.classList.add('active');
            }
        });

        // 新增：音量图标点击事件
        volumeIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = volumePanel.classList.contains('show');
            // 隐藏其他面板
            scrollPanel.classList.remove('show');
            sizePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
            // 切换当前面板
            if (isVisible) {
                volumePanel.classList.remove('show');
                volumeIcon.classList.remove('active');
            } else {
                volumePanel.classList.add('show');
                volumeIcon.classList.add('active');
            }
        });

        // 新增：键盘尺寸图标点击事件
        sizeIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = sizePanel.classList.contains('show');
            // 隐藏其他面板
            scrollPanel.classList.remove('show');
            volumePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            volumeIcon.classList.remove('active');
            // 切换当前面板
            if (isVisible) {
                sizePanel.classList.remove('show');
                sizeIcon.classList.remove('active');
            } else {
                sizePanel.classList.add('show');
                sizeIcon.classList.add('active');
            }
        });

        // 点击其他地方隐藏面板
        document.addEventListener('click', () => {
            scrollPanel.classList.remove('show');
            volumePanel.classList.remove('show');
            sizePanel.classList.remove('show');
            scrollIcon.classList.remove('active');
            volumeIcon.classList.remove('active');
            sizeIcon.classList.remove('active');
        });

        // 阻止面板内部点击事件冒泡
        scrollPanel.addEventListener('click', (e) => e.stopPropagation());
        volumePanel.addEventListener('click', (e) => e.stopPropagation());
        sizePanel.addEventListener('click', (e) => e.stopPropagation());

        // 滚动灵敏度面板滚轮事件
        scrollPanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newValue = Math.max(0.1, Math.min(3, scrollSensitivity + delta));
            scrollSensitivity = newValue;
            scrollSensitivityInput.value = newValue;
            localStorage.setItem('scrollSensitivity', scrollSensitivity.toString());
        }, { passive: false });

        // 音量面板滚轮事件
        volumePanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            const newValue = Math.max(0, Math.min(1, currentVolume + delta));
            currentVolume = newValue;
            volumeControlInput.value = newValue;
            localStorage.setItem('currentVolume', currentVolume.toString());
            window.preload.setGlobalVolume(currentVolume);
            
            if (volumeDebounceTimer) {
                clearTimeout(volumeDebounceTimer);
            }
            volumeDebounceTimer = setTimeout(() => {
                window.preload.playNote('C4', currentVolume);
            }, 300);
        }, { passive: false });

        // 新增：监听滚动灵敏度滑动条的变化
        scrollSensitivityInput.addEventListener('input', (e) => {
            scrollSensitivity = parseFloat(e.target.value);
            localStorage.setItem('scrollSensitivity', scrollSensitivity.toString()); // 保存到 localStorage
        });

        // 新增：监听音量控制滑动条的变化
        volumeControlInput.addEventListener('input', (e) => {
            currentVolume = parseFloat(e.target.value);
            localStorage.setItem('currentVolume', currentVolume.toString()); // 保存到 localStorage
            window.preload.setGlobalVolume(currentVolume); // 调用 preload.js 中的全局音量设置函数
            
            // 清除之前的定时器
            if (volumeDebounceTimer) {
                clearTimeout(volumeDebounceTimer);
            }
            
            // 设置新的定时器，300ms后播放音量提示
            volumeDebounceTimer = setTimeout(() => {
                window.preload.playNote('C4', currentVolume);
            }, 300);
        });

        // 新增：监听键盘映射显示开关的变化
        showKeyboardMappingCheckbox.addEventListener('change', (e) => {
            showKeyboardMapping = e.target.checked;
            localStorage.setItem('showKeyboardMapping', showKeyboardMapping.toString());
            generatePianoKeys(); // 重新生成钢琴键以应用新的显示设置
        });

        // 新增：监听音高显示下拉框的变化
        noteDisplaySelect.addEventListener('change', (e) => {
            currentNoteDisplayMode = e.target.value;
            localStorage.setItem('noteDisplayMode', currentNoteDisplayMode); // 保存到 localStorage
            generatePianoKeys(); // 重新生成钢琴键以应用新的显示模式
        });

        // 新增：监听琴键效果下拉框的变化
        keyEffectSelect.addEventListener('change', (e) => {
            currentKeyEffectMode = e.target.value;
            localStorage.setItem('keyEffectMode', currentKeyEffectMode); // 保存到 localStorage
            // 不重新生成琴键，因为效果只影响 active 状态和飞行动画，不影响键的生成
        });



        // 新增：监听键盘尺寸滑动条的变化
        keyboardSizeInput.addEventListener('input', (e) => {
            keyboardSizeRatio = parseFloat(e.target.value);
            localStorage.setItem('keyboardSizeRatio', keyboardSizeRatio.toString());
            sizeIcon.title = `键盘尺寸 (当前: ${keyboardSizeRatio.toFixed(1)}，全屏显示时为1)`;
            generatePianoKeys();
        });

        // 键盘尺寸面板滚轮事件
        sizePanel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newValue = Math.max(0.5, Math.min(2.0, keyboardSizeRatio + delta));
            keyboardSizeRatio = newValue;
            keyboardSizeInput.value = newValue;
            localStorage.setItem('keyboardSizeRatio', keyboardSizeRatio.toString());
            sizeIcon.title = `键盘尺寸 (当前: ${keyboardSizeRatio.toFixed(1)}，全屏显示时为1)`;
            generatePianoKeys();
        }, { passive: false });

        // 自定义下拉框功能
        function initCustomSelect(selectElement, currentValue, onChangeCallback) {
            const trigger = selectElement.querySelector('.custom-select-trigger');
            const options = selectElement.querySelector('.custom-select-options');
            const optionElements = selectElement.querySelectorAll('.custom-select-option');
            
            // 设置初始值
            const initialOption = selectElement.querySelector(`[data-value="${currentValue}"]`);
            if (initialOption) {
                trigger.textContent = initialOption.textContent;
                optionElements.forEach(opt => opt.classList.remove('selected'));
                initialOption.classList.add('selected');
            }
            
            // 点击触发器
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // 关闭其他下拉框
                document.querySelectorAll('.custom-select-options.show').forEach(opt => {
                    if (opt !== options) opt.classList.remove('show');
                });
                options.classList.toggle('show');
            });
            
            // 点击选项
            optionElements.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    const text = option.textContent;
                    
                    trigger.textContent = text;
                    optionElements.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    options.classList.remove('show');
                    
                    onChangeCallback(value);
                });
            });
        }
        
        // 初始化音高显示下拉框
        initCustomSelect(noteDisplaySelect, currentNoteDisplayMode, (value) => {
            currentNoteDisplayMode = value;
            localStorage.setItem('noteDisplayMode', currentNoteDisplayMode);
            generatePianoKeys();
        });
        
        // 初始化琴键效果下拉框
        initCustomSelect(keyEffectSelect, currentKeyEffectMode, (value) => {
            currentKeyEffectMode = value;
            localStorage.setItem('keyEffectMode', currentKeyEffectMode);
        });
        
        // 点击其他地方关闭下拉框
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select-options.show').forEach(options => {
                options.classList.remove('show');
            });
        });

    </script>
</body>

</html>